<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>HR Email Response Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen p-6">
<div class="max-w-3xl mx-auto bg-white rounded-2xl shadow p-6">
    <h1 class="text-2xl font-semibold mb-2">HR Candidate Email Tool</h1>
    <p class="text-sm text-gray-500 mb-4">Preview and send candidate emails (Selection / Rejection).</p>

    <form id="emailForm" class="grid grid-cols-1 gap-3">
        <div>
            <label class="text-sm font-medium">Candidate Name</label>
            <input id="candidateName" required class="mt-1 block w-full rounded-lg border-gray-300 p-2" />
        </div>

        <div>
            <label class="text-sm font-medium">Candidate Email</label>
            <input id="candidateEmail" type="email" required class="mt-1 block w-full rounded-lg border-gray-300 p-2" />
        </div>

        <div>
            <label class="text-sm font-medium">Position</label>
            <input id="position" required class="mt-1 block w-full rounded-lg border-gray-300 p-2" />
        </div>

        <div>
            <label class="text-sm font-medium">Status</label>
            <div class="mt-1 flex items-center gap-4">
                <label class="inline-flex items-center"><input type="radio" name="status" value="Selected" checked class="mr-2">Selected</label>
                <label class="inline-flex items-center"><input type="radio" name="status" value="Rejected" class="mr-2">Rejected</label>
            </div>
        </div>

        <div>
            <label class="text-sm font-medium">Sender (optional)</label>
            <input id="fromEmail" placeholder="hr@mycompany.com" class="mt-1 block w-full rounded-lg border-gray-300 p-2" />
            <p class="text-xs text-gray-400 mt-1">If left blank, server default `app.mail.from` is used.</p>
        </div>

        <div>
            <button type="button" id="previewBtn" class="px-4 py-2 rounded-lg bg-indigo-600 text-white">Preview</button>
            <button type="button" id="sendBtn" class="px-4 py-2 rounded-lg bg-green-600 text-white ml-3" disabled>Send</button>
        </div>

        <div id="messages" class="mt-2"></div>

        <div id="previewArea" class="hidden mt-4">
            <h3 class="text-lg font-medium">Preview</h3>
            <div class="mt-2 p-4 border rounded bg-gray-50">
                <div class="mb-2"><strong>Subject:</strong> <span id="previewSubject" class="break-words"></span></div>
                <div class="mb-2"><strong>Body:</strong></div>
                <textarea id="previewBody" rows="8" class="w-full rounded border p-2 text-sm"></textarea>
                <p class="text-xs text-gray-400 mt-2">Edit the body if you want to override before sending.</p>
            </div>
        </div>
    </form>
</div>

<div id="toast" class="fixed right-6 bottom-6 bg-green-600 text-white px-4 py-2 rounded shadow hidden"></div>

<script>
    const previewBtn = document.getElementById('previewBtn');
    const sendBtn = document.getElementById('sendBtn');
    const previewArea = document.getElementById('previewArea');
    const previewSubject = document.getElementById('previewSubject');
    const previewBody = document.getElementById('previewBody');
    const messages = document.getElementById('messages');
    const toast = document.getElementById('toast');

    function showMessage(html, type='info') {
      messages.innerHTML = `<div class="p-2 rounded ${type==='error'?'bg-red-100 text-red-700':'bg-blue-50 text-blue-700'}">${html}</div>`;
    }

    function showToast(text, ok=true) {
      toast.textContent = text;
      toast.classList.remove('hidden');
      toast.style.backgroundColor = ok ? '#059669' : '#dc2626';
      setTimeout(()=> toast.classList.add('hidden'), 3000);
    }

    function gatherForm() {
      const name = document.getElementById('candidateName').value.trim();
      const email = document.getElementById('candidateEmail').value.trim();
      const position = document.getElementById('position').value.trim();
      const status = document.querySelector('input[name="status"]:checked').value;
      const fromEmail = document.getElementById('fromEmail').value.trim();
      return { candidateName: name, candidateEmail: email, position, status, fromEmail };
    }

    async function postJson(path, payload) {
      const resp = await fetch(path, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      return resp;
    }

    previewBtn.addEventListener('click', async () => {
      messages.innerHTML = '';
      const payload = gatherForm();
      // Basic client-side validation
      if (!payload.candidateName || !payload.candidateEmail || !payload.position) {
        showMessage('Please fill name, email and position.', 'error');
        return;
      }
      try {
        const res = await postJson('/api/preview', payload);
        if (!res.ok) {
          const err = await res.json().catch(()=>({message:'Preview failed'}));
          showMessage('Preview error: ' + (err.message || JSON.stringify(err)), 'error');
          return;
        }
        const data = await res.json();
        previewSubject.textContent = data.subject;
        previewBody.value = data.body;
        previewArea.classList.remove('hidden');
        sendBtn.disabled = false;
        showMessage('Preview generated. Edit if needed, then click Send.');
      } catch (e) {
        showMessage('Network error: ' + e.message, 'error');
      }
    });

    sendBtn.addEventListener('click', async () => {
      const base = gatherForm();
      base.overrideBody = previewBody.value;
      try {
        const res = await postJson('/api/send', base);
        const j = await res.json();
        if (!res.ok) {
          showMessage('Send failed: ' + (j.message || JSON.stringify(j)), 'error');
          showToast('Send failed', false);
          return;
        }
        showMessage('Email sent successfully!', 'info');
        showToast('Email sent âœ…', true);
        // reset form
        document.getElementById('emailForm').reset();
        previewArea.classList.add('hidden');
        sendBtn.disabled = true;
      } catch (e) {
        showMessage('Network error: ' + e.message, 'error');
        showToast('Network error', false);
      }
    });
</script>
</body>
</html>
